---
title: Redis
date: 2026-01-16
category:
  - 运维
tags:
  - Linux
  - redis
  - 运维
---
# Redis

## 一、NoSQL 概述

**NoSQL（Not Only SQL）** 指的是**非关系型数据库**，通常用于以下场景：

- 高并发访问
- 海量数据存储
- 低延迟读写

### 常见 NoSQL 类型

- **Key-Value 型**：Redis
- **文档型**：MongoDB
---

## 二、CAP 理论

在分布式系统中，以下三点**无法同时满足**，最多只能满足其中两点：
- **C（一致性，Consistency）**：所有节点在同一时间看到的数据一致
- **A（可用性，Availability）**：每次请求都能获得响应（不保证数据最新）
- **P（分区容忍性，Partition Tolerance）**：系统能够容忍网络分区或节点失联

---
## 三、Redis 安装


---

## 四、Redis 数据类型

### 1. String（字符串）

- 最基础的数据类型
- 单个 value 最大 **512 MB**
**使用场景：**
- 缓存对象（JSON 字符串）
- 计数器
- Token / Session

---

### 2. List（列表）
- 有序、可重复
- 基于**双向链表**实现
- 支持从两端插入和弹出
**使用场景：**
- 消息队列
- 时间线
- 任务列表
---

### 3. Set（集合）

- 无序
- 元素不可重复
- 支持交集、并集、差集运算
**使用场景：**
- 共同好友
- 数据去重
- 点赞 / 关注
---

### 4. Sorted Set（有序集合，ZSet）

- 元素唯一
- 每个元素关联一个 `score`
- 根据 `score` 自动排序
**使用场景：**
- 排行榜
- 延迟队列
- 权重排序
---
### 5. Hash（哈希）
- 结构：`key → field → value`
**使用场景：**
- 存储对象
- 用户信息
---
## 五、Redis 持久化机制

### 1. RDB（快照持久化）

定期将内存中的数据生成快照文件 `dump.rdb`。

#### （1）save

手动触发 RDB 持久化，**同步阻塞**生成 `dump.rdb` 文件。

> ⚠️ `save` 会阻塞 Redis 主线程，期间服务不可用。

**工作方式：**

- Redis 主线程直接执行
    
- 执行期间：
    
    - 停止处理所有客户端请求
        
    - 所有读写操作阻塞
        
- 持久化完成后恢复服务
    

---

#### （2）bgsave（推荐）

后台**异步触发** RDB 持久化。

**工作方式：**

- 主进程：
    - `fork()` 一个子进程
- 子进程：
    - 负责生成 RDB 文件
- 主进程：
    - 继续处理客户端请求
    - 
**核心机制（写时复制，COW）：**
- 子进程读取 fork 时的内存数据
- 主进程发生写操作时：
    - 操作系统复制被修改的内存页

**优点：**
- 数据一致
- 服务不中断

---

### 2. AOF（追加日志持久化）

以**日志形式**记录每一条写命令，类似 MySQL 的 binlog。

#### AOF 三种刷盘策略

1. **always**
    - 每条命令都刷盘
    - 数据最安全
    - 性能最差
2. everysec
    - 每秒刷盘一次
    - 最多丢失 1 秒数据
    - 性能与安全性平衡最好
3. **no**
    - 由操作系统决定刷盘时机
    - 性能最好
    - 数据安全性最差
---
## 六、面试高频考点

### 1. 缓存问题

#### （1）缓存穿透

**原因：**
- 查询数据库中不存在的数据
- 请求绕过缓存直接打到数据库
**解决方案：**
- **布隆过滤器**：
    - 在接口前增加校验层
    - 快速拦截不存在的非法请求
- **缓存空对象**：
    - 将查询结果为 null 的数据缓存
    - 过期时间设置较短，防止占用内存
---
#### （2）缓存击穿

**原因：**
- 某个热点 Key 在过期瞬间
- 大量并发请求同时访问数据库
**解决方案：**
- **互斥锁（最常用）**：
    - 只允许一个线程查询数据库并回写缓存
- **热点数据永不过期**：
    - 物理不过期
    - 后台异步更新
- **逻辑过期**：
    - 在 value 中存储过期时间
    - 过期后异步刷新
    - 请求期间返回旧数据
---
#### （3）缓存雪崩

**原因：**
- 大量缓存同时过期
- Redis 服务宕机
**解决方案：**
- 过期时间增加**随机值（Jitter）**
- Redis 集群 / 哨兵机制，提高可用性
- **多级缓存**：
    - 本地缓存（如 Caffeine）+ Redis
- **熔断与降级**：
    - 流量过大时返回默认值
    - 保护数据库
---
### 2. Redis 优化
- 设置内存策略：
    ```bash
    sysctl vm.overcommit_memory=1
    ```
- 在配置文件中**禁用危险命令**（如 `FLUSHALL`）
- 可通过终端**临时修改端口或密码**（测试环境）
---

## 七、Redis 备份

### RDB 默认备份策略


---

## 八、Redis 启动时的数据恢复顺序

> Redis 启动时，**优先使用 AOF 文件恢复数据**，如果 AOF 不存在才使用 RDB。
---
## 九、切换到 AOF 持久化的步骤

1. 终端执行命令开启 AOF：
    ```bash
    CONFIG SET appendonly yes
    ```
2. 修改配置文件：
    
    ```conf
    appendonly yes
    ```
    > 无需重启服务