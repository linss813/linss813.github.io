---
title: Redis
date: 2026-01-16
category:
  - 运维
tags:
  - Linux
  - redis
  - 运维
---

# Redis
## NoSQL
NoSQL（Not Only SQL）是指**非关系型数据库**，通常用于：
- 高并发
- 海量数据
- 低延迟访问

常见 NoSQL 类型：
- Key-Value（Redis）
- 文档型（MongoDB）

CAP 理论
分布式系统无法同时满足以下三点，只能满足其中两点：
- C（一致性）：所有节点数据一致
- A（可用性）：每次请求都能得到响应
- P（分区容忍性）：系统能容忍网络分区
- ---
## Redis安装


## Redis 数据类型
- **字符串：String**  
	-  最基础类型、最大512M
	- 场景：缓存对象 json、计数器、token/session
- **列表：List**（有序，可重复）
	- 双向的链表，可以从两端插入/弹出，有顺序
	- 场景：消息队列、时间线、任务列表
- **集合：Set**（无序，不重复）
	- 无顺序的，会自动去重，支持交并差运算
	- 场景：共同好友、去重、点赞 / 关注
- **有序集合：Sorted Set（zset）**
	- 有序，每个元素有 score
	- 场景： 排行榜、延迟队列、权重排序
- **哈希：Hash** 
	- key → field → value
	- 场景：存储对象、用户信息
--- 
## Redis 持久化机制

### RDB
定期将内存数据生成快照文件（dump.rdb）
#### save
手动触发 RDB 持久化，会同步生成 dump.rdb 文件。

> save 是**同步阻塞**操作，会导致 Redis 服务不可用。

**工作方式：**
- Redis 主线程执行
- 在执行期间：
	- 停止处理所有客户端请求
	- 读写全部阻塞
- 持久化完成后才恢复服务
#### bgsave
用于**后台异步触发 RDB 持久化**，是 Redis **推荐使用**的方式。

**工作方式：**
- Redis 主线程：
    - fork() 一个子进程
- 子进程：
    - 负责生成 RDB 文件
- 主进程：
    - 继续处理客户端请求
**核心机制：**
- fork 后：
    - 子进程读取原始内存数据
    - 主进程若发生写操作：
        - 操作系统复制被修改的内存页
- 保证：
    - 数据一致
    - 服务不中断

### AOF
记录每一条写命令，类似mysql的二进制日志方式
#### AOF 的三种刷盘策略
1. always
	每条命令都刷盘、数据最安全、性能最差
2. everysec
	 每秒刷盘一次、最多丢 1 秒数据、性能和安全性平衡最好
3. no
	 由操作系统决定刷盘、性能最好数据风险最高



## 面试
### 缓存
- 缓存传透
	- 原因：查询不存在的数据，请求穿过缓存直接打到数据库。
	- 解决方法：
		- 布隆过滤器：在接口校验前加一层布隆过滤器，快速拦截不存在的非法请求。
		- 缓存空对象：对查询后不存在的数据设置一个键值对记录为null，期时间要设短一点，防止占内存。
- 缓存击穿
	- 原因：单个热点 Key 在过期的一瞬间，海量请求同时涌入，导致数据库瞬间崩溃。
	- 解决方法：
		- 互斥锁：当缓存失效时，只允许一个线程去查库并回写缓存，其他请求等待或重试。【最常用】
	    - 设置热点数据永不过期：物理不过期，但后台异步更新。 
	    - 逻辑过期：在 Value 中存储过期时间，发现过期后由异步线程去更新，期间请求返回旧数据。
- 缓存雪崩
	-  原因：大量缓存在同时集中失效，或者 Redis 服务宕机，导致压力全部转向数据库。
	- 解决方法：
		- 过期时间加随机值 (Jitter)，防止它们集体同时到期。
		- 利用 Redis 集群/哨兵：提高可用性，防止因 Redis 宕机导致的雪崩。
		- 多级缓存：增加本地缓存（如 Caffeine），作为最后一层屏障。
		- 熔断与降级：当流量超过阈值，直接返回默认值或友好提示，保护数据库。
### Redis优化
- 内存`sysctL vm.overcommit_memory=1`
- 通过在配置问文件内修改实现禁用危险命令的效果
- 通过直接从终端快速临时修改端口、登陆密码

备份
RDB默认备份策略
![](assets/Pasted%20image%2020260116160450.png)
### Redis 启动时的数据恢复顺序

#### 切换到AOF备份方式步骤
1. 在终端使用命令启动`appendonly` 
2. 修改配置文件 `appendonly yes` 不需要重启服务